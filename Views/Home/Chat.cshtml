@model List<Dream_Bridge.Models.Main.ChatMessage>
@using System.Security.Claims

@{
    ViewData["Title"] = "Chat";
    var adminId = (int)(ViewData["AdminId"] ?? 0); // Ép kiểu adminId sang int
    var adminName = ViewData["AdminName"]?.ToString() ?? "Admin"; // Get admin name
    var userName = User.FindFirst(ClaimTypes.Name)?.Value ?? "User"; // Get the user's name
}
<div class="container mx-auto p-8 bg-white rounded-xl shadow-lg border border-blue-500 text-blue-900">
    <h1 class="text-3xl font-bold text-center mb-8 text-blue-600">Chat with @adminName</h1>

    <div id="chat-messages" class="rounded-lg p-4 mb-6 h-96 overflow-y-auto bg-blue-50 shadow-inner">
        @foreach (var message in Model)
        {
            var senderName = (message.SenderId == adminId) ? adminName : userName;
            <div class="mb-4 flex flex-col @((message.SenderId == adminId) ? "items-start" : "items-end")">
                <!-- Display sender's name -->
                <span class="text-blue-600 font-semibold text-xs mb-1">@senderName</span>

                <!-- Message container with bubble -->
                <div
                    class="relative flex flex-col gap-2 rounded-lg px-5 py-3 shadow-lg 
                    @((message.SenderId == adminId) ? "bg-blue-200" : "bg-green-200 text-grey-600") max-w-xs break-words">
                    <p>@message.MessageText</p>

                    @if (!string.IsNullOrEmpty(message.AttachmentUrl))
                    {
                        <div class="mt-3">
                            <a href="@message.AttachmentUrl" target="_blank" class="inline-block">
                                <img src="@message.AttachmentUrl" alt="Attachment"
                                    class="max-w-full max-h-52 rounded-lg shadow-lg hover:shadow-xl transition-transform transform hover:scale-105" />
                            </a>
                        </div>
                    }

                    <!-- Time displayed below the message -->
                    <span class="text-gray-500 text-xs self-end">@message.CreatedAt?.ToString("hh:mm")</span>
                </div>

                <!-- Delete button outside the bubble -->
                @if (message.SenderId.ToString() == User.FindFirst(ClaimTypes.NameIdentifier)?.Value)
                {
                    <form method="post" action="@Url.Action("DeleteChatMessage", "Home")" class="mt-2 flex justify-end w-full">
                        <input type="hidden" name="messageId" value="@message.IdMessage" />
                        <button type="submit" class="text-red-500 hover:text-red-700 text-xs underline">Delete</button>
                    </form>
                }
            </div>
        }
    </div>

    <form id="chat-form" method="post" enctype="multipart/form-data" action="@Url.Action("SendChatMessage", "Home")"
        class="flex items-center mt-4 bg-white p-3 rounded-full shadow-lg border border-blue-300">
        <input type="text" name="messageText" id="messageText"
            class=" border-none rounded-full px-4 py-2 flex-grow focus:outline-none text-blue-500 placeholder-blue-400"
            placeholder="Type your message..." required />
        <input type="file" name="attachment" id="attachment" class="hidden" />
        <input type="hidden" name="receiverId" value="@adminId" />
        <button type="submit"
            class="bg-blue-500 text-white rounded-full px-4 py-2 ml-3 shadow-lg hover:bg-blue-600 transition duration-300">Send</button>
    </form>
</div>

@section Scripts {
    <script>
        const chatMessages = document.getElementById("chat-messages");
        chatMessages.scrollTop = chatMessages.scrollHeight;
    </script>
}
